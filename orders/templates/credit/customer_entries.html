<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title> CREDIT ENTRY</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-600">{{ customer.name }}</h1>
      <a href="{% url 'payment_status_by_customer' customer_id=customer.id %}"
   class="mt-2 sm:mt-0 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
  <i class="fas fa-arrow-left mr-2"></i> Back to All  Entries
</a>
    </header>

    {% if messages %}
    <div class="space-y-3 my-4">
        {% for message in messages %}
        <div class="px-4 py-3 rounded-lg flex items-start gap-3 text-sm
            {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-300
            {% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-300
            {% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800 border border-yellow-300
            {% else %}bg-blue-100 text-blue-800 border border-blue-300{% endif %}">
            <i class="fas
                {% if message.tags == 'success' %}fa-check-circle
                {% elif message.tags == 'error' %}fa-times-circle
                {% elif message.tags == 'warning' %}fa-exclamation-triangle
                {% else %}fa-info-circle{% endif %}
                mt-0.5"></i>
            <span>{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Main Entry Card -->
    <div class="bg-white shadow-lg rounded-xl border border-gray-200 overflow-hidden">
      <!-- Card Header -->
      <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 text-white">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-bold">
            <i class="fas fa-file-invoice mr-2"></i>
            Invoice: {{ credit_entry.delivery_order.invoice_number }}
          </h2>
          <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm font-medium">
            {% if credit_entry.payment_received %}
              <i class="fas fa-check-circle mr-1"></i> Paid
            {% else %}
              <i class="fas fa-clock mr-1"></i> {{ credit_entry.status_of_approval }}
            {% endif %}
          </span>
        </div>
      </div>

      <!-- Card Content -->
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-gray-500 mb-2">BASIC DETAILS</h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-600">Order Date:</span>
                <span class="font-medium">{{ credit_entry.delivery_order.date }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Due Date:</span>
                <span class="font-medium">{{ credit_entry.due_date }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Exceeded Days:</span>
                <span class="font-medium {% if credit_entry.exceeded_days > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                  {{ credit_entry.exceeded_days }}
                </span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Payment Term:</span>
                <span class="font-medium">{{ credit_entry.delivery_order.customer.credit_limit }} days</span>
              </div>

            </div>
          </div>

          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-gray-500 mb-2">FINANCIAL DETAILS</h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-600">Amount:</span>
                <span class="font-medium">{{ credit_entry.delivery_order.amount }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Cheque Date:</span>
                <span class="font-medium">{{ credit_entry.customer_cheque_date|default:"Not provided" }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Remark:</span>
                <span class="font-medium">{{ credit_entry.remark|default:"-" }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Credit Limit:</span>
                <span class="font-medium">{{ credit_entry.delivery_order.customer.credit_limit_amount|default:"-" }} AED</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Additional Terms:</span>
                <span class="font-medium">{{ credit_entry.delivery_order.customer.additional_terms|default:"-" }} </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Sections -->
        <div class="space-y-6">
          <!-- Cheque Date Update -->
          <div class="border-t border-gray-200 pt-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
              <i class="fas fa-calendar-check mr-2 text-blue-500"></i>
              Cheque Date Action
            </h3>
            {% if not credit_entry.payment_received %}
              <form method="POST"
                    action="{% url 'check_cheque_date' customer_id=customer.id entry_id=credit_entry.id %}"
                    class="flex flex-col sm:flex-row gap-4 items-start sm:items-end"
                    id="cheque-date-form">
                {% csrf_token %}
                <div class="flex-1">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Cheque Date</label>
                  <input type="date"
                         name="cheque_date"
                         id="cheque_date_input"
                         value="{{ credit_entry.customer_cheque_date|date:'Y-m-d' }}"
                         class="w-full border rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                         required>
                </div>
                <button type="button"
                        id="check-date-btn"
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition flex items-center">
                  <i class="fas fa-check-circle mr-2"></i> Update Date
                </button>
              </form>
            {% else %}
              <div class="bg-green-50 text-green-800 p-3 rounded-md flex items-center">
                <i class="fas fa-check-circle mr-2 text-green-600"></i>
                Payment has been received for this invoice
              </div>
            {% endif %}
          </div>

          <!-- MD Submission Section - This will be shown/hidden via JavaScript when cheque date exceeds -->
          <div id="md-submission-section" class="border-t border-gray-200 pt-6" style="display: none;">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
              <i class="fas fa-paper-plane mr-2 text-yellow-500"></i>
              Submit to MD for Approval
            </h3>
            <!-- Highlight that cheque date exceeds -->
            <div class="bg-red-50 text-red-700 p-3 rounded-md mb-4 flex items-center">
              <i class="fas fa-exclamation-circle mr-2"></i>
              The cheque date exceeds the customer's credit limit. MD approval required.
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Remarks</label>
                <textarea id="md-remarks"
                          placeholder="Enter reason for MD approval..."
                          class="w-full border rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500 h-24"></textarea>
              </div>
              <div class="flex justify-end gap-3">
                <button type="button"
                        id="cancel-md-btn"
                        class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition">
                  Cancel
                </button>
                <button type="button"
                        id="send-to-md-btn"
                        class="bg-yellow-500 text-black px-4 py-2 rounded-md hover:bg-yellow-600 transition flex items-center">
                  <i class="fas fa-paper-plane mr-2"></i> Send to MD
                </button>
              </div>
            </div>
          </div>

          <!-- Original MD Submission Section for Exceeded Days (keep this as is) -->
          {% if not credit_entry.payment_received %}
            {% if credit_entry.status_of_approval == "Not Accepted" or credit_entry.status_of_approval == "Declined" %}
            <div class="border-t border-gray-200 pt-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-paper-plane mr-2 text-yellow-500"></i>
                Submit to MD for Approval
              </h3>
              <form method="POST"
                    action="{% url 'submit_request_to_md' customer_id=customer.id entry_id=credit_entry.id %}"
                    class="space-y-4"
                    onsubmit="return sendWhatsappOld('{{ credit_entry.delivery_order.invoice_number }}', this)">
                {% csrf_token %}
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Remarks</label>
                  <textarea name="remark"
                            required
                            placeholder="Enter reason for MD approval..."
                            class="w-full border rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500 h-24"></textarea>
                </div>
                <div class="flex justify-end gap-3">
                  <a href="{% url 'customer_credit_entries' customer_id=customer.id entry_id=credit_entry.id %}"
                     class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition">
                    Cancel
                  </a>
                  <button type="submit"
                          class="bg-yellow-500 text-black px-4 py-2 rounded-md hover:bg-yellow-600 transition flex items-center">
                    <i class="fas fa-paper-plane mr-2"></i> Send to MD
                  </button>
                </div>
              </form>
            </div>
            {% elif credit_entry.status_of_approval == "Pending" and credit_entry.remark %}
            <div class="border-t border-gray-200 pt-6">
              <div class="bg-yellow-50 text-yellow-800 p-3 rounded-md flex items-center">
                <i class="fas fa-clock mr-2 text-yellow-600"></i>
                This request has already been submitted to MD for approval
              </div>
            </div>
            {% endif %}
          {% endif %}

          {% if credit_entry.status_of_approval == "Approved" and not credit_entry.payment_received %}
          <div class="border-t border-gray-200 pt-6">
            <form method="POST"
                  action="{% url 'mark_payment_received' customer_id=customer.id entry_id=credit_entry.id %}"
                  class="flex justify-end">
              {% csrf_token %}
              <button type="submit"
                      class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition flex items-center">
                <i class="fas fa-check-double mr-2"></i> Mark Payment Received
              </button>
            </form>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    function sendWhatsappOld(invoiceNumber, form) {
      const remark = form.querySelector('textarea[name="remark"]').value;
      const message = `Invoice: ${invoiceNumber}%0ARemark: ${encodeURIComponent(remark)}%0AKindly approve.`;
      const number = '971542677947';
      const whatsappUrl = `https://wa.me/${number}?text=${message}`;
      window.open(whatsappUrl, '_blank');
      return true;
    }

    function checkChequeDate() {
      const chequeDate = new Date(document.getElementById('cheque_date_input').value);
      const dueDate = new Date('{{ credit_entry.due_date|date:"Y-m-d" }}');

      return chequeDate > dueDate;
    }

    document.addEventListener('DOMContentLoaded', function() {
  const chequeDateForm = document.getElementById('cheque-date-form');
  const mdSection = document.getElementById('md-submission-section');
  const checkDateBtn = document.getElementById('check-date-btn');
  const sendToMdBtn = document.getElementById('send-to-md-btn');
  const cancelMdBtn = document.getElementById('cancel-md-btn');

  // Handle "Update Date" button click
  checkDateBtn.addEventListener('click', function() {
    // First validate the date is entered
    const chequeDateInput = document.getElementById('cheque_date_input');
    if (!chequeDateInput.value) {
      alert('Please enter a cheque date');
      return;
    }

    // Save the date immediately via AJAX
    fetch(chequeDateForm.action, {
      method: 'POST',
      body: new FormData(chequeDateForm),
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
  if (data.success) {
    if (data.approved) {
      // Cheque date is within due date, auto approved
      window.location.reload();
    } else {
      // Cheque date exceeds due date
      mdSection.style.display = 'block';
      mdSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  } else {
    alert('Error saving date: ' + (data.message || 'Unknown error'));
  }
})
    .catch(error => {
      console.error('Error:', error);
      alert('Error saving cheque date');
    });
  });

  // Rest of your existing JS for MD submission...
  cancelMdBtn.addEventListener('click', function() {
    mdSection.style.display = 'none';
  });

  sendToMdBtn.addEventListener('click', function() {
    const remarks = document.getElementById('md-remarks').value.trim();

    if (!remarks) {
      alert('Please provide remarks for MD approval.');
      return;
    }

        // Send WhatsApp message
        const invoiceNumber = '{{ credit_entry.delivery_order.invoice_number }}';
        const message = `Invoice: ${invoiceNumber}%0ARemark: ${encodeURIComponent(remarks)}%0AKindly approve.`;
        const number = '919995973954';
        const whatsappUrl = `https://wa.me/${number}?text=${message}`;

        // Create a form to submit to MD approval endpoint
        const mdForm = document.createElement('form');
        mdForm.method = 'POST';
        mdForm.action = "{% url 'submit_request_to_md' customer_id=customer.id entry_id=credit_entry.id %}";

        // Add CSRF token
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        mdForm.appendChild(csrfToken);

        // Add remark
        const remarkInput = document.createElement('input');
        remarkInput.type = 'hidden';
        remarkInput.name = 'remark';
        remarkInput.value = remarks;
        mdForm.appendChild(remarkInput);

        // Add form to body
        document.body.appendChild(mdForm);

        // Open WhatsApp in a new window
        window.open(whatsappUrl, '_blank');

        // Submit the form after a brief delay to ensure WhatsApp opens
        setTimeout(function() {
          mdForm.submit();
        }, 500);
      });
    });
  </script>
</body>
</html>