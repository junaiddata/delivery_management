<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Combined Credit Entries</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  >
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto p-4">

    <!-- Header -->
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
      <div>
        <h1 class="text-2xl font-bold text-blue-600">{{ customer.name }}</h1>
        <p class="text-gray-600 mt-1">Combined Credit Entries</p>
      </div>
      <a href="{% url 'payment_status_by_customer' customer_id=customer.id %}"
         class="mt-2 sm:mt-0 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
        <i class="fas fa-arrow-left mr-2"></i> Back to All Entries
      </a>
    </header>

    {% if messages %}
    <div class="space-y-3 my-4">
      {% for message in messages %}
      <div class="px-4 py-3 rounded-lg flex items-start gap-3 text-sm
                  {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-300
                  {% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-300
                  {% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800 border border-yellow-300
                  {% else %}bg-blue-100 text-blue-800 border border-blue-300{% endif %}">
        <i class="fas
           {% if message.tags == 'success' %}fa-check-circle
           {% elif message.tags == 'error' %}fa-times-circle
           {% elif message.tags == 'warning' %}fa-exclamation-triangle
           {% else %}fa-info-circle{% endif %} mt-0.5"></i>
        <span>{{ message }}</span>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Summary Card -->
    <div class="bg-white shadow-lg rounded-xl border border-gray-200 overflow-hidden mb-6">
      <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 text-white">
        <h2 class="text-xl font-bold">
          <i class="fas fa-file-invoice-dollar mr-2"></i> Summary of Selected Entries
        </h2>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-gray-500 mb-2">TOTAL INVOICES</h3>
            <p class="text-2xl font-bold text-blue-600">{{ entries|length }}</p>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-gray-500 mb-2">TOTAL AMOUNT</h3>
            <p class="text-2xl font-bold text-green-600">{{ total_amount }} AED</p>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-gray-500 mb-2">CREDIT LIMIT</h3>
            <p class="text-2xl font-bold
               {% if total_amount > customer.credit_limit_amount %}text-red-600{% else %}text-gray-600{% endif %}">
              {{ customer.credit_limit_amount|default:"-" }} AED
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Entries Table -->
    <div class="bg-white shadow-lg rounded-xl border border-gray-200 overflow-hidden">
      <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 text-white">
        <h2 class="text-xl font-bold">
          <i class="fas fa-list-ol mr-2"></i> Selected Credit Entries
        </h2>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Invoice</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Due Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Exceeded Days</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for entry in entries %}
            <tr>
              <td class="px-6 py-4 whitespace-nowrap font-medium text-blue-600">
                {{ entry.delivery_order.invoice_number }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">{{ entry.delivery_order.date }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ entry.due_date }}</td>
              <td class="px-6 py-4 whitespace-nowrap font-medium">{{ entry.delivery_order.amount }} AED</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 rounded-full text-xs font-medium
                  {% if entry.exceeded_days > 0 %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">
                  {{ entry.exceeded_days }} days
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if entry.payment_received %}
                  <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <i class="fas fa-check-circle mr-1"></i> Paid
                  </span>
                {% else %}
                  <span class="px-2 py-1 rounded-full text-xs font-medium
                    {% if entry.status_of_approval == 'Approved' %}bg-blue-100 text-blue-800
                    {% elif entry.status_of_approval == 'Pending' %}bg-yellow-100 text-yellow-800
                    {% elif entry.status_of_approval == 'Declined' %}bg-red-100 text-red-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {{ entry.status_of_approval }}
                  </span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <a href="{% url 'customer_credit_entries' customer_id=customer.id entry_id=entry.id %}"
                   class="text-blue-600 hover:text-blue-900">
                  <i class="fas fa-eye"></i> View
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="px-6 py-4 text-center text-gray-500">No entries found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Bulk Actions -->
    <div class="mt-6 bg-white shadow-lg rounded-xl border border-gray-200 overflow-hidden">
      <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 text-white">
        <h2 class="text-xl font-bold">
          <i class="fas fa-tasks mr-2"></i> Bulk Actions
        </h2>
      </div>
      <div class="p-6 space-y-6">

        <!-- 1) Always: Cheque Date Update -->
<!-- Bulk Update Cheque Dates -->
<div class="border-b border-gray-200 pb-4">
  <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
    <i class="fas fa-calendar-check mr-2 text-blue-500"></i> Update Cheque Dates
  </h3>
  <form method="POST" action="{% url 'bulk_update_cheque_dates' customer_id=customer.id %}">
    {% csrf_token %}
    <!-- Single input holding all selected entry IDs as a comma-separated string -->
    <input type="hidden" name="entry_ids"
           value="{% for eid in selected_entry_ids %}{{ eid }}{% if not forloop.last %},{% endif %}{% endfor %}">

    <label class="block text-sm font-medium text-gray-700 mb-1">Cheque Date</label>
    <input type="date" name="cheque_date"
           class="w-full border rounded-md px-3 py-2 mb-2 focus:ring-blue-500 focus:border-blue-500"
           required>

    <button type="submit"
            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
      <i class="fas fa-save mr-2"></i> Update Selected
    </button>
  </form>
</div>


        <!-- 2) Only if all cheques are within due date -->
        {% if show_mark_paid %}
        <div class="border-b border-gray-200 pb-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-check-double mr-2 text-green-500"></i> Mark All as Paid
          </h3>
          <form method="POST" action="{% url 'bulk_mark_paid' customer_id=customer.id %}"
                onsubmit="return confirm('Are you sure you want to mark all selected entries as paid?');">
            {% csrf_token %}
            <input type="hidden" name="entry_ids"
                   value="{% for entry in entries %}{{ entry.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
            <button type="submit"
                    class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">
              <i class="fas fa-check-double mr-2"></i> Mark All as Paid
            </button>
          </form>
        </div>
        {% endif %}

        <!-- 3) Only if at least one cheque is overdue -->
        {% if show_submit_to_md %}
        <div>
          <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-paper-plane mr-2 text-yellow-500"></i> Submit All to MD
          </h3>
          <!-- Highlight that cheque date exceeds -->
            <div class="bg-red-50 text-red-700 p-3 rounded-md mb-4 flex items-center">
              <i class="fas fa-exclamation-circle mr-2"></i>
              The cheque date exceeds some customer's invoices payment term. MD approval required.
            </div>
          <form method="POST" action="{% url 'bulk_submit_to_md' customer_id=customer.id %}"
                class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="entry_ids"
                   value="{% for entry in entries %}{{ entry.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
            <label class="block text-sm font-medium text-gray-700 mb-1">Remarks</label>
            <textarea name="remark" required
                      class="w-full border rounded-md px-3 py-2 h-24 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="Enter reason for MD approval..."></textarea>
            <div class="flex justify-end">
              <button type="submit"
                      class="bg-yellow-500 text-black px-4 py-2 rounded-md hover:bg-yellow-600 transition">
                <i class="fas fa-paper-plane mr-2"></i> Submit All to MD
              </button>
            </div>
          </form>
        </div>
        {% endif %}

      </div>
    </div>

  </div>
</body>
<!-- Add this at the bottom of the template -->
<!--<div class="mt-6 p-4 bg-gray-100 rounded-lg">-->
<!--    <h3 class="font-bold text-lg mb-2">Debug Information</h3>-->
<!--    <p><strong>Selected Entry IDs:</strong> -->
<!--        {% for eid in selected_entry_ids %}{{ eid }}{% if not forloop.last %}, {% endif %}{% endfor %}-->
<!--    </p>-->
<!--    <p><strong>Entries Count:</strong> {{ entries|length }}</p>-->
<!--    <p><strong>Show Mark Paid:</strong> {{ show_mark_paid|yesno:"Yes,No" }}</p>-->
<!--    <p><strong>Show Submit to MD:</strong> {{ show_submit_to_md|yesno:"Yes,No" }}</p>-->
<!--</div>-->
</html>
